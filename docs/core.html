---

title: Core

keywords: fastai
sidebar: home_sidebar

summary: "Core functions for MRL, mostly low level plumbing and parallel processing"
description: "Core functions for MRL, mostly low level plumbing and parallel processing"
nb_path: "nbs/00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Miscellaneous-Functions">Miscellaneous Functions<a class="anchor-link" href="#Miscellaneous-Functions"> </a></h2><p>Low level helper functions</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="is_container" class="doc_header"><code>is_container</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/core.py#L10" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>is_container</code>(<strong><code>x</code></strong>)</p>
</blockquote>
<p>check if <code>x</code> is a container (used for parallel processing)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="flatten_recursive" class="doc_header"><code>flatten_recursive</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/core.py#L17" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>flatten_recursive</code>(<strong><code>list_of_lists</code></strong>)</p>
</blockquote>
<p>Recursively flattel list of lists</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="flatten_list_of_lists" class="doc_header"><code>flatten_list_of_lists</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/core.py#L28" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>flatten_list_of_lists</code>(<strong><code>list_of_lists</code></strong>)</p>
</blockquote>
<p>Flattens list of lists (not recursive)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="deduplicate_list" class="doc_header"><code>deduplicate_list</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/core.py#L32" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>deduplicate_list</code>(<strong><code>l</code></strong>)</p>
</blockquote>
<p>Deduplicates list l</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="chunk_list" class="doc_header"><code>chunk_list</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/core.py#L36" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>chunk_list</code>(<strong><code>input_list</code></strong>, <strong><code>chunksize</code></strong>)</p>
</blockquote>
<p>Breaks <code>input_list</code> into chunks of size <code>chunksize</code>, ragged on last list</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="filter_passing" class="doc_header"><code>filter_passing</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/core.py#L40" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>filter_passing</code>(<strong><code>inputs</code></strong>, <strong><code>bools</code></strong>)</p>
</blockquote>
<p>Subsets <code>inputs</code> (list) by <code>bools</code> (list of bools)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">flatten_list_of_lists</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">]])</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">flatten_recursive</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]]]])</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Parallel-Processing">Parallel Processing<a class="anchor-link" href="#Parallel-Processing"> </a></h2><p>MRL tries to build in automatic parallel processing at every level. This can make a huge difference when you're processing millions of molecules</p>
<p><a href="/mrl/core#maybe_parallel"><code>maybe_parallel</code></a> is a convenient wrapper for parallel processing. The given <code>func</code> is wrapped with <code>**kwargs</code> and used to process the <code>iterable</code>. If <code>iterable</code> is a <code>list</code> or <code>np.ndarray</code>, the elements in <code>iterable</code> are run in parallel by <code>func</code>.</p>
<p><a href="/mrl/core#maybe_parallel"><code>maybe_parallel</code></a> defaults to using all availlable CPUs for processing. To control CPU usage, either pass in a specific number for the <code>cpus</code> argument, or set <code>ncpus</code> as an environment variable:</p>
<p><code>os.environ['ncpus'] = '8'</code></p>
<p>Passing <code>cpus=0</code> or setting <code>os.environ['ncpus'] = '0'</code> causes <a href="/mrl/core#maybe_parallel"><code>maybe_parallel</code></a> to default to serial processing</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="maybe_parallel" class="doc_header"><code>maybe_parallel</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/core.py#L46" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>maybe_parallel</code>(<strong><code>func</code></strong>, <strong><code>iterable</code></strong>, <strong><code>cpus</code></strong>=<em><code>None</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_func</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">maybe_parallel</span><span class="p">(</span><span class="n">test_func</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Serial time: </span><span class="si">{</span><span class="n">t1</span><span class="o">-</span><span class="n">start</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, Parallel time: </span><span class="si">{</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">Results will depend on the number of CPUs available&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Serial time: 10.03, Parallel time: 1.09.
Results will depend on the number of CPUs available
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Debugging-Parallel-Processing">Debugging Parallel Processing<a class="anchor-link" href="#Debugging-Parallel-Processing"> </a></h2><p>Errors in parallel processing can be difficult to debug because the true error and stack trace are obscured by the parallel processing stack trace. If you have errors in parallel processing, first try setting <code>os.environ['ncpus'] = '0'</code> to disable python multiprocessing. This should reveal the true error.</p>
<p>If everything works fine when multiprocessing is disabled, it is likely one of your functions is failing to pickle.</p>

</div>
</div>
</div>
</div>
 

