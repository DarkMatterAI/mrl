---

title: Reward

keywords: fastai
sidebar: home_sidebar

summary: "Rewards - non-differentiable scores for samples"
description: "Rewards - non-differentiable scores for samples"
nb_path: "nbs/21_reward.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/21_reward.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">Overview<a class="anchor-link" href="#Overview"> </a></h2><p>Rewards are non-differentiable score functions for evaluating samples. Rewards should generally follow the format <code>reward = f(sample)</code></p>
<p>Rewards in MRL occupy five events in the fit loop:</p>
<ul>
<li><code>before_compute_reward</code> - set up necessary values prior to reward calculation (if needed)</li>
<li><code>compute_reward</code> - compute reward</li>
<li><code>after_compute_reward</code> - compute metrics (if needed)</li>
<li><code>reward_modification</code> - adjust rewards</li>
<li><code>after_reward_modification</code> - compute metrics (if needed)</li>
</ul>
<h3 id="Rewards-vs-Reward-Modifications">Rewards vs Reward Modifications<a class="anchor-link" href="#Rewards-vs-Reward-Modifications"> </a></h3><p>MRl breaks rewards up into two phases - rewards and reward modifications. The difference between the two phases is that <strong>reward</strong> values are saved in the batch log, while <strong>reward_modifications</strong> are not.</p>
<p>In this framework, rewards are absolute scores for samples that are used to evaluate the sample relative to all other samples in the log. Reward modifications are transient scores that depend on the current training context.</p>
<p>A reward modification might be something like adding a score bonus to compounds the first time they are created during training to encourage diversity, or penalizing compounds if they appear more than 3 times in the last 5 batches. These types of reward modifications allow us to influence the behavior of the generative model without having these scores effect the true rewards we save in the log</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Reward-Callbacks">Reward Callbacks<a class="anchor-link" href="#Reward-Callbacks"> </a></h2><p>Rewards are used to generate non-differentiable scores from samples. Differentiable scores should be implemented as a <a href="/mrl/losses#LossCallback"><code>LossCallback</code></a>.</p>
<p>Rewards are calculated after sample creation but before generating model outputs. Use the <code>before_compute_reward</code> event to create any values needed for your reward calculation.</p>
<p>Rewards are called after sample creation. At this point in the fit loop, rewards have access to the samples themselves and any other attributes generated during the sample process. Rewards do not have access to model outputs</p>
<p>LossCallback</p>
<p>before_compute_reward</p>
<p>Loss function callbacks compute some loss value from the current batch state and add the resulting value to <a href="/mrl/callback_core#BatchState.loss"><code>BatchState.loss</code></a>.</p>
<p><a href="/mrl/losses#LossCallback"><code>LossCallback</code></a> provides a simple hook for custom loss funcions. Any object with a <code>from_batch_state</code> method that returns a scalar value can be passed to <a href="/mrl/losses#LossCallback"><code>LossCallback</code></a>. Ex:</p>

<pre><code>class MyLoss():
    def from_batch_state(self, batch_state):
        loss = self.do_loss_calculation()
        return loss</code></pre>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Reward" class="doc_header"><code>class</code> <code>Reward</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/reward.py#L15" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Reward</code>(<strong><code>reward_function</code></strong>, <strong><code>weight</code></strong>=<em><code>1</code></em>, <strong><code>bs</code></strong>=<em><code>None</code></em>, <strong><code>log</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RewardCallback" class="doc_header"><code>class</code> <code>RewardCallback</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/reward.py#L88" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RewardCallback</code>(<strong><code>reward</code></strong>, <strong><code>name</code></strong>, <strong><code>sample_name</code></strong>=<em><code>'samples'</code></em>, <strong><code>order</code></strong>=<em><code>10</code></em>, <strong><code>track</code></strong>=<em><code>True</code></em>) :: <a href="/mrl/callback_core#Callback"><code>Callback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RewardModification" class="doc_header"><code>class</code> <code>RewardModification</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/callbacks/core.py#L255" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RewardModification</code>() :: <a href="/mrl/callback_core#Event"><code>Event</code></a></p>
</blockquote>
<p>RewardModification</p>
<p>This event is used to modify rewards before they
are used to compute the model's loss. Reward modifications
encompass changes to rewards in the context of the current
training cycle. These are things like "give a score bonus
to new samples that havent't been seen before" or "penalize
the score of samples that have occurred in the last 5 batches".</p>
<p>These types of modifications are kept separate from the core
reward for logging purposes. Samples are logged with their
respective rewards. These logged scores are referenced later
when samples are drawn from the log. This means we need the
logged score to be independent from "batch context" type scores</p>
<p>All reward modifications should be
applied to <code>self.environmemnt.batch_state.rewards</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="NoveltyReward" class="doc_header"><code>class</code> <code>NoveltyReward</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/reward.py#L154" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>NoveltyReward</code>(<strong><code>weight</code></strong>=<em><code>1.0</code></em>, <strong><code>track</code></strong>=<em><code>True</code></em>) :: <a href="/mrl/callback_core#Callback"><code>Callback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ContrastiveReward" class="doc_header"><code>class</code> <code>ContrastiveReward</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/reward.py#L186" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ContrastiveReward</code>(<strong><code>base_reward</code></strong>, <strong><code>max_score</code></strong>=<em><code>None</code></em>) :: <a href="/mrl/reward#RewardCallback"><code>RewardCallback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

