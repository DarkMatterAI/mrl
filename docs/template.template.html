---

title: Templates


keywords: fastai
sidebar: home_sidebar

summary: "Templates are used to define chemical spaces using easily calculable properties"
description: "Templates are used to define chemical spaces using easily calculable properties"
nb_path: "nbs/03_template.template.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/03_template.template.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/dmai/miniconda3/envs/mrl/lib/python3.7/importlib/_bootstrap.py:219: RuntimeWarning: to-Python converter for boost::shared_ptr&lt;RDKit::FilterCatalogEntry const&gt; already registered; second conversion method ignored.
  return f(*args, **kwds)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview">Overview<a class="anchor-link" href="#Overview"> </a></h2><p>Templates are a core concept in MRL used to define chemical spaces. Templates collect a series of molecular heuristics and validate if a molecule meets those criteria. For example:</p>

<pre><code>Molecular weight: 250-450
Rotatable bonds: Less than 8
PAINS Filter: Pass</code></pre>
<p>Templates can also be used to assign a score for meeting heuristic criteria. This allows us to define different criteria for <strong>must-have</strong> molecular properties versus <strong>nice-to-have_</strong> chemical properties. In a reinforcement learning context, this translates into giving a score bonus to molecules that fit the nice-to-have criteria. Scores can also be negative to allow for penalizing a molecule that still passes the must-have criteria.</p>

<pre><code>Must Have:
Molecular weight: 250-450, 
Rotatable bonds: Less than 8
PAINS Filter: Pass

Nice To Have:
Molecular weight: 350-400 (+1), 
TPSA: Less than 80 (+1)
Substructure Match: '[#6]1:[#6]:[#7]:[#6]:[#6]:[#6]:1' (+3)
Substructure Match: '[#6]1:[#6]:[#7]:[#7]:[#7]:[#6]:1' (-1)</code></pre>
<p>Based on the above criteria, a molecule that passes the must-have criteria could get a score between -1 and +5 based on meeting the nice-to-have criteria.</p>
<p>Templates are instantiated through the <a href="/mrl/template.template.html#Template"><code>Template</code></a> class. A template is a collections of filters, created through the <a href="/mrl/template.filters.html#Filter"><code>Filter</code></a> class. See <a href="/mrl/template.filters.html#Filter"><code>Filter</code></a> for more details on defining filter functions.</p>
<p>Templates contain two sets of filters - hard filters and soft filters. Hard filters contain the must-have criteria for a molecule, while the soft filters contain the nice-to-have criteria.</p>
<p>During model training, a generative model creates a batch of compounds. These compounds are first screened against the hard filters. Compounds that fail the hard filters can then be excluded from the training batch or assigned a default failure score. Compounds that pass the hard filters are then scored using the soft filters. Soft filters can provide a small score bonus or penalty for a molecule in addition to the main score function.</p>
<p>Soft filters incentivise a generative model to maximize the soft filter conditions without making them a hard requirement. This allows soft filters to be highly targeted towards narrow property ranges or highly specific substructures. If these highly targeted criteria were set as hard filters, they might invalidate too many compounds and cause the model to struggle during training.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Templates">Templates<a class="anchor-link" href="#Templates"> </a></h2><p>The <a href="/mrl/template.template.html#Template"><code>Template</code></a> class holds a collection of hard filters and soft filters and manages screening a molecule against those filters. Templates by default log the filter results in detail, allowing you to inspect which filters a molecule failed.</p>
<p>Templates can be merged by adding templates together, ie <code>new_template = template1 + template2</code>. Adding two templates merges the hard and soft filters in each template.</p>
<p>Templates by default will log all molecules passed through the hard and soft filters to an internal dataframe, and build a lookup table of <code>{smile : final_score}</code>. The first time a molecule is screened, it is added to the internal dataframe and lookup table. If that molecule is seen again (defined by the smiles string), the lookup value is returned. If this behavior isn't desired, pass <code>log=False</code> to disable all logging and lookup, or <code>use_lookup=False</code> to keep logging but avoid using the lookup table.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Template" class="doc_header"><code>class</code> <code>Template</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/templates/template.py#L14" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Template</code>(<strong><code>hard_filters</code></strong>, <strong><code>soft_filters</code></strong>=<em><code>None</code></em>, <strong><code>log</code></strong>=<em><code>False</code></em>, <strong><code>use_lookup</code></strong>=<em><code>False</code></em>, <strong><code>fail_score</code></strong>=<em><code>0.0</code></em>, <strong><code>cpus</code></strong>=<em><code>None</code></em>, <strong><code>mode</code></strong>=<em><code>'smile'</code></em>)</p>
</blockquote>
<p>Template - class for managing hard and soft filters</p>
<p>Inputs:</p>
<ul>
<li><p><code>hard_filters list[Filter]</code>: list of <a href="/mrl/template.filters.html#Filter"><code>Filter</code></a> objects used for pass/fail screening</p>
</li>
<li><p><code>soft_filters list[Filter]</code>: list of <a href="/mrl/template.filters.html#Filter"><code>Filter</code></a> objects used for soft scoring</p>
</li>
<li><p><code>log bool</code>: if True, template will log screened compounds</p>
</li>
<li><p><code>use_lookup bool</code>: if True, filter results are stored in a lookup table. If a compound
is re-screened, the lookup value is returned</p>
</li>
<li><p><code>fail_score float</code>: placeholder score for compounds that fail to pass hard filters</p>
</li>
<li><p><code>cpus Optional[int]</code>: number of CPUs to use. If None, defaults to <code>os.environ['ncpus']</code></p>
</li>
<li><p><code>mode str['smile', 'protein', 'dna', 'rna']</code>: determines
how inputs are converted to Mol objects</p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BlankTemplate" class="doc_header"><code>class</code> <code>BlankTemplate</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/templates/template.py#L338" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BlankTemplate</code>(<strong>**<code>template_kwargs</code></strong>) :: <a href="/mrl/template.template.html#Template"><code>Template</code></a></p>
</blockquote>
<p>Empty template (no hard or soft filters)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ValidMoleculeTemplate" class="doc_header"><code>class</code> <code>ValidMoleculeTemplate</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/templates/template.py#L343" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ValidMoleculeTemplate</code>(<strong><code>hard</code></strong>=<em><code>True</code></em>, <strong><code>soft</code></strong>=<em><code>False</code></em>, <strong>**<code>template_kwargs</code></strong>) :: <a href="/mrl/template.template.html#Template"><code>Template</code></a></p>
</blockquote>
<p>Template for checking if an input is a single valid chemical structure</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RuleOf5Template" class="doc_header"><code>class</code> <code>RuleOf5Template</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/templates/template.py#L365" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RuleOf5Template</code>(<strong><code>hard</code></strong>=<em><code>True</code></em>, <strong><code>soft</code></strong>=<em><code>False</code></em>, <strong>**<code>template_kwargs</code></strong>) :: <a href="/mrl/template.template.html#Template"><code>Template</code></a></p>
</blockquote>
<p>Template for Lipinski's rule of 5 (en.wikipedia.org/wiki/Lipinski%27s_rule_of_five)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="GhoseTemplate" class="doc_header"><code>class</code> <code>GhoseTemplate</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/templates/template.py#L391" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>GhoseTemplate</code>(<strong><code>hard</code></strong>=<em><code>True</code></em>, <strong><code>soft</code></strong>=<em><code>False</code></em>, <strong>**<code>template_kwargs</code></strong>) :: <a href="/mrl/template.template.html#Template"><code>Template</code></a></p>
</blockquote>
<p>Template for Ghose filters (doi.org/10.1021/cc9800071)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="VeberTemplate" class="doc_header"><code>class</code> <code>VeberTemplate</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/templates/template.py#L417" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>VeberTemplate</code>(<strong><code>hard</code></strong>=<em><code>True</code></em>, <strong><code>soft</code></strong>=<em><code>False</code></em>, <strong>**<code>template_kwargs</code></strong>) :: <a href="/mrl/template.template.html#Template"><code>Template</code></a></p>
</blockquote>
<p>Template for Veber filters (doi.org/10.1021/jm020017n)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="REOSTemplate" class="doc_header"><code>class</code> <code>REOSTemplate</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/templates/template.py#L439" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>REOSTemplate</code>(<strong><code>hard</code></strong>=<em><code>True</code></em>, <strong><code>soft</code></strong>=<em><code>False</code></em>, <strong>**<code>template_kwargs</code></strong>) :: <a href="/mrl/template.template.html#Template"><code>Template</code></a></p>
</blockquote>
<p>Template for REOS filters (10.1016/s0169-409x(02)00003-0)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RuleOf3Template" class="doc_header"><code>class</code> <code>RuleOf3Template</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/templates/template.py#L471" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RuleOf3Template</code>(<strong><code>hard</code></strong>=<em><code>True</code></em>, <strong><code>soft</code></strong>=<em><code>False</code></em>, <strong>**<code>template_kwargs</code></strong>) :: <a href="/mrl/template.template.html#Template"><code>Template</code></a></p>
</blockquote>
<p>Template for rule of 5 filter (doi.org/10.1016/S1359-6446(03)02831-9)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">smiles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;c1ccccc1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Cc1cc(NC)ccc1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Cc1cc(NC)cnc1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Cc1cccc(NCc2ccccc2)c1&#39;</span>
<span class="p">]</span>

<span class="n">mols</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_mol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">smiles</span><span class="p">]</span>

<span class="c1"># hard filters</span>
<span class="n">hard_filters</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ValidityFilter</span><span class="p">(),</span>
    <span class="n">SingleCompoundFilter</span><span class="p">(),</span>
    <span class="n">MolWtFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
    <span class="n">HBDFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">HBAFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">LogPFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="p">]</span>

<span class="c1"># soft filters</span>
<span class="n">soft_filters</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">TPSAFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">RotBondFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">StructureFilter</span><span class="p">([</span><span class="s1">&#39;[*]-[#6]1:[#6]:[#6]:[#6]2:[#7]:[#6]:[#7H]:[#6]:2:[#6]:1&#39;</span><span class="p">],</span>
                    <span class="n">exclude</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>

<span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">hard_filters</span><span class="p">,</span> <span class="n">soft_filters</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">template</span><span class="o">.</span><span class="n">hf</span><span class="p">(</span><span class="s1">&#39;CC1=CN=C(C(=C1OC)C)CS(=O)C2=NC3=C(N2)C=C(C=C3)OC&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">template</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="s1">&#39;CC1=CN=C(C(=C1OC)C)CS(=O)C2=NC3=C(N2)C=C(C=C3)OC&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mf">3.0</span>
<span class="k">assert</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;CC1=CN=C(C(=C1OC)C)CS(=O)C2=NC3=C(N2)C=C(C=C3)OC&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">hard_filters</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">soft_filters</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">hard_filters</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">soft_filters</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

<span class="k">assert</span> <span class="p">(</span><span class="n">t1</span><span class="o">+</span><span class="n">t2</span><span class="p">)(</span><span class="n">mols</span><span class="p">)</span> <span class="o">==</span> <span class="n">template</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">t1</span><span class="o">+</span><span class="n">t2</span><span class="p">)(</span><span class="n">mols</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;soft&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">template</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="s1">&#39;soft&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="n">RuleOf3Template</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;files/smiles.csv&#39;</span><span class="p">)</span>
<span class="n">passes</span><span class="p">,</span> <span class="n">fails</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">screen_mols</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">smiles</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">passes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">92</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s1">&#39;hard&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">final</span><span class="o">.</span><span class="n">values</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">template</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;files/test_temp.template&#39;</span><span class="p">,</span> <span class="n">with_data</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">template2</span> <span class="o">=</span> <span class="n">Template</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s1">&#39;files/test_temp.template&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">template2</span><span class="o">.</span><span class="n">hard_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span>
<span class="k">assert</span> <span class="n">template</span><span class="o">.</span><span class="n">hard_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">2000</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;files/test_temp.template&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">([])</span>
<span class="k">assert</span> <span class="n">template</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="n">RuleOf3Template</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;protein&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">template</span><span class="p">([</span><span class="s1">&#39;MAAR&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

