---

title: Combichem


keywords: fastai
sidebar: home_sidebar

summary: "Combinatorial chemistry functions"
description: "Combinatorial chemistry functions"
nb_path: "nbs/23_combichem.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/23_combichem.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/home/dmai/miniconda3/envs/mrl/lib/python3.7/importlib/_bootstrap.py:219: RuntimeWarning: to-Python converter for boost::shared_ptr&lt;RDKit::FilterCatalogEntry const&gt; already registered; second conversion method ignored.
  return f(*args, **kwds)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Combichem">Combichem<a class="anchor-link" href="#Combichem"> </a></h2><p>Combichem methods use stochastic rules-based molecular changes to generate new compounds. Combichem consists of the following steps:</p>
<ol>
<li>Library generation - create the next iteration of the library</li>
<li>Library scoring - apply a numeric score to each item in the library</li>
<li>Library pruning - remove low scoring compounds</li>
</ol>
<p>Library generation consists of two main steps - <strong>mutation</strong> and <strong>crossover</strong>.</p>
<p>A mutation is a process that maps a single molecule to a new molecule. Custom mutations can be created by subclassing <a href="/mrl/combichem.html#Mutator"><code>Mutator</code></a></p>
<p>Crossover is a process where a pair of molelcules is used to generate a new molecule that contains features of each parent molecule. Custom crossovers can be created by subclassing <a href="/mrl/combichem.html#Crossover"><code>Crossover</code></a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Crossover" class="doc_header"><code>class</code> <code>Crossover</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L21" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Crossover</code>(<strong><code>name</code></strong>=<em><code>'crossover'</code></em>)</p>
</blockquote>
<p>Crossover - base class for crossover events.
To create custom crossovers, subclass <a href="/mrl/combichem.html#Crossover"><code>Crossover</code></a>
and implement the <a href="/mrl/combichem.html#Crossover.crossover"><code>Crossover.crossover</code></a> method</p>
<p>When called, <a href="/mrl/combichem.html#Crossover"><code>Crossover</code></a> is passed a list of <code>Mol</code>
objects. The crossover operation randomly generates
molecular pairs, and sends those pairs to <a href="/mrl/combichem.html#Crossover.crossover"><code>Crossover.crossover</code></a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="Crossover.crossover" class="doc_header"><code>Crossover.crossover</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L52" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>Crossover.crossover</code>(<strong><code>mol_pair</code></strong>)</p>
</blockquote>
<p>crossover - performs crossover operation</p>
<p>Inputs:</p>
<p><code>mol_pair list[Chem.Mol, Chem.Mol]</code>: list of two
Mol objects</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FragmentCrossover" class="doc_header"><code>class</code> <code>FragmentCrossover</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L65" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FragmentCrossover</code>(<strong><code>full_crossover</code></strong>=<em><code>False</code></em>, <strong><code>name</code></strong>=<em><code>'fragment crossover'</code></em>) :: <a href="/mrl/combichem.html#Crossover"><code>Crossover</code></a></p>
</blockquote>
<p>FragmentCrossover - crossover based on
molecular fragmentation.</p>
<p>Each Mol is fragmented into a set of
<code>(scaffold, rgroup)</code> pairs by cutting
single bonds in the molecule.</p>
<p>During crossover, molecular pairs are
merged following <code>scaffold1 + rgroup2</code></p>
<p>Inputs:</p>
<p><code>full_crossover bool</code>: if True, all
<code>scaffold, rgroup</code> combinations are generated</p>
<p><code>name str</code>: crossover name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;files/smiles.csv&#39;</span><span class="p">)</span>
<span class="n">mols</span> <span class="o">=</span> <span class="n">to_mols</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">smiles</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
<span class="n">cx</span> <span class="o">=</span> <span class="n">FragmentCrossover</span><span class="p">()</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">cx</span><span class="p">(</span><span class="n">mols</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Mutator" class="doc_header"><code>class</code> <code>Mutator</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L136" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Mutator</code>(<strong><code>name</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Mutator - base class for mutations.
To create custom mutations, subclass
<a href="/mrl/combichem.html#Mutator"><code>Mutator</code></a> and implement <a href="/mrl/combichem.html#Mutator.mutate"><code>Mutator.mutate</code></a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SmartsMutator" class="doc_header"><code>class</code> <code>SmartsMutator</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L176" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SmartsMutator</code>(<strong><code>smarts</code></strong>, <strong><code>name</code></strong>=<em><code>None</code></em>) :: <a href="/mrl/combichem.html#Mutator"><code>Mutator</code></a></p>
</blockquote>
<p>SmartsMutator - SMARTS reaction based
mutator.</p>
<p>Inputs:</p>
<p><code>smarts list[str]</code>: list of SMARTS reaction strings</p>
<p><code>name str</code>: mutator name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ChangeAtom" class="doc_header"><code>class</code> <code>ChangeAtom</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L227" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ChangeAtom</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>ChangeAtom - SMARTS-based mutator that
changes atom type without changing
molecular structure</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AppendAtomSingle" class="doc_header"><code>class</code> <code>AppendAtomSingle</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L247" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AppendAtomSingle</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>AppendAtomSingle - SMARTS-based mutator
that appends an atom somewhere on the
input structure with a single bond</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AppendAtomsDouble" class="doc_header"><code>class</code> <code>AppendAtomsDouble</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L264" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AppendAtomsDouble</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>AppendAtomsDouble - SMARTS-based mutator
that appends an atom somewhere on the
input structure with a double bond</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AppendAtomsTriple" class="doc_header"><code>class</code> <code>AppendAtomsTriple</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L281" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AppendAtomsTriple</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>AppendAtomsTriple - SMARTS-based mutator
that appends an atom somewhere on the
input structure with a triple bond</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AppendAtom" class="doc_header"><code>class</code> <code>AppendAtom</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L298" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AppendAtom</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>AppendAtom - SMARTS-based mutator
that appends an atom somewhere on the
input structure.</p>
<p>Combines <a href="/mrl/combichem.html#AppendAtomSingle"><code>AppendAtomSingle</code></a>,
<a href="/mrl/combichem.html#AppendAtomsDouble"><code>AppendAtomsDouble</code></a> and <a href="/mrl/combichem.html#AppendAtomsTriple"><code>AppendAtomsTriple</code></a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DeleteAtom" class="doc_header"><code>class</code> <code>DeleteAtom</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L315" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DeleteAtom</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>DeleteAtom - SMARTS-based mutator
that randomly deletes an atom from
the input structure</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ChangeBond" class="doc_header"><code>class</code> <code>ChangeBond</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L333" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ChangeBond</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>ChangeBond - SMARTS-based mutator
that randomly changes a bond in the
input structure</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="InsertAtomSingle" class="doc_header"><code>class</code> <code>InsertAtomSingle</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L351" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>InsertAtomSingle</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>InsertAtomSingle - SMARTS-based mutator
that randomly inserts an atom into
the input structure with single bonds</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="InsertAtomDouble" class="doc_header"><code>class</code> <code>InsertAtomDouble</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L368" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>InsertAtomDouble</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>InsertAtomDouble - SMARTS-based mutator
that randomly inserts an atom into
the input structure with a double bond</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="InsertAtomTriple" class="doc_header"><code>class</code> <code>InsertAtomTriple</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L387" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>InsertAtomTriple</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>InsertAtomTriple - SMARTS-based mutator
that randomly inserts an atom into
the input structure with a triple bond</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="InsertAtom" class="doc_header"><code>class</code> <code>InsertAtom</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L400" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>InsertAtom</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>InsertAtom - SMARTS-based mutator
that randomly inserts an atom into
the input structure.</p>
<p>Combines <a href="/mrl/combichem.html#InsertAtomSingle"><code>InsertAtomSingle</code></a>,
<a href="/mrl/combichem.html#InsertAtomDouble"><code>InsertAtomDouble</code></a> and <a href="/mrl/combichem.html#InsertAtomTriple"><code>InsertAtomTriple</code></a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AddRing" class="doc_header"><code>class</code> <code>AddRing</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L417" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AddRing</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>AddRing - SMARTS-based mutator
that randomly creates rings</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AllSmarts" class="doc_header"><code>class</code> <code>AllSmarts</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L433" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AllSmarts</code>() :: <a href="/mrl/combichem.html#SmartsMutator"><code>SmartsMutator</code></a></p>
</blockquote>
<p>AllSmarts - SMARTS-based mutator
that combines <a href="/mrl/combichem.html#ChangeAtom"><code>ChangeAtom</code></a>,
<a href="/mrl/combichem.html#AppendAtom"><code>AppendAtom</code></a>, <a href="/mrl/combichem.html#DeleteAtom"><code>DeleteAtom</code></a>,
<a href="/mrl/combichem.html#ChangeBond"><code>ChangeBond</code></a>, <a href="/mrl/combichem.html#InsertAtom"><code>InsertAtom</code></a>,
and <a href="/mrl/combichem.html#AddRing"><code>AddRing</code></a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AppendRgroupMutator" class="doc_header"><code>class</code> <code>AppendRgroupMutator</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L453" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AppendRgroupMutator</code>(<strong><code>rgroups</code></strong>, <strong><code>name</code></strong>=<em><code>'Rgroup'</code></em>) :: <a href="/mrl/combichem.html#Mutator"><code>Mutator</code></a></p>
</blockquote>
<p>AppendRgroupMutator - randomly
appends r-groups to the input molecule</p>
<p>Inputs:</p>
<p><code>rgroups list[str]</code>: list of rgroups. All
rgroups should have a single wildcard (<code>*</code>) atom</p>
<p><code>name str</code>: mutator name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="EnumerateHeterocycleMutator" class="doc_header"><code>class</code> <code>EnumerateHeterocycleMutator</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L498" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>EnumerateHeterocycleMutator</code>(<strong><code>depth</code></strong>=<em><code>None</code></em>, <strong><code>name</code></strong>=<em><code>'enum heteroatoms'</code></em>) :: <a href="/mrl/combichem.html#Mutator"><code>Mutator</code></a></p>
</blockquote>
<p>EnumerateHeterocycleMutator - mutates
input molecule by enumerating nitrogens
on heterocycles</p>
<p>Inputs:</p>
<p><code>depth int</code>: number of recursive enumerations</p>
<p><code>name str</code>: mutator name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">EnumerateHeterocycleMutator</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">smiles</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>72</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ShuffleNitrogen" class="doc_header"><code>class</code> <code>ShuffleNitrogen</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L523" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ShuffleNitrogen</code>(<strong><code>n_shuffles</code></strong>, <strong><code>name</code></strong>=<em><code>'shuffle nitrogen'</code></em>) :: <a href="/mrl/combichem.html#Mutator"><code>Mutator</code></a></p>
</blockquote>
<p>ShuffleNitrogen - mutates input molecule
by shuffling the positions of carbon and nitrogen
atoms in the molecule</p>
<p>Inputs:</p>
<p><code>n_shuffles int</code>: number of shuffled variants to
generate</p>
<p><code>name str</code>: mutator name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ContractAtom" class="doc_header"><code>class</code> <code>ContractAtom</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L571" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ContractAtom</code>(<strong><code>include_rings</code></strong>=<em><code>True</code></em>, <strong><code>name</code></strong>=<em><code>'contract'</code></em>) :: <a href="/mrl/combichem.html#Mutator"><code>Mutator</code></a></p>
</blockquote>
<p>ContractAtom - mutates input molecule by
removing an atom with two bonds and joining
the removed atoms neighbors with a single bond.</p>
<p>ie <code>a-b-c -&gt; a-c</code></p>
<p>Inputs:</p>
<p><code>include_rings bool</code>: if True, rings will be
contracted</p>
<p><code>name str</code>: mutator name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SelfiesMutator" class="doc_header"><code>class</code> <code>SelfiesMutator</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L630" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SelfiesMutator</code>(<strong><code>n_augs</code></strong>, <strong><code>name</code></strong>=<em><code>'selfies'</code></em>) :: <a href="/mrl/combichem.html#Mutator"><code>Mutator</code></a></p>
</blockquote>
<p>SelfiesMutator - base class for SELFIES
based mutation</p>
<p>Inputs:</p>
<p><code>n_augs int</code>: number of mutated versions
to generate</p>
<p><code>name str</code>: mutator name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SelfiesInsert" class="doc_header"><code>class</code> <code>SelfiesInsert</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L670" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SelfiesInsert</code>(<strong><code>n_augs</code></strong>, <strong><code>name</code></strong>=<em><code>'selfies insert'</code></em>) :: <a href="/mrl/combichem.html#SelfiesMutator"><code>SelfiesMutator</code></a></p>
</blockquote>
<p>SelfiesInsert - SELFIES insertion mutator.
Randomly inserts a SELFIES token into
the input compound</p>
<p>Inputs:</p>
<p><code>n_augs int</code>: number of mutated versions
to generate</p>
<p><code>name str</code>: mutator name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">SelfiesInsert</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">mol</span> <span class="o">=</span> <span class="n">to_mol</span><span class="p">(</span><span class="s1">&#39;c1ccccc1&#39;</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">mol</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>20</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SelfiesReplace" class="doc_header"><code>class</code> <code>SelfiesReplace</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L694" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SelfiesReplace</code>(<strong><code>n_augs</code></strong>, <strong><code>name</code></strong>=<em><code>'selfies replace'</code></em>) :: <a href="/mrl/combichem.html#SelfiesMutator"><code>SelfiesMutator</code></a></p>
</blockquote>
<p>SelfiesReplace - SELFIES replacement mutator.
Randomly replaces a SELFIES token in
the input compound</p>
<p>Inputs:</p>
<p><code>n_augs int</code>: number of mutated versions
to generate</p>
<p><code>name str</code>: mutator name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">SelfiesReplace</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">mol</span> <span class="o">=</span> <span class="n">to_mol</span><span class="p">(</span><span class="s1">&#39;c1ccccc1&#39;</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">mol</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>20</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SelfiesRemove" class="doc_header"><code>class</code> <code>SelfiesRemove</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L718" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SelfiesRemove</code>(<strong><code>n_augs</code></strong>, <strong><code>name</code></strong>=<em><code>'selfies remove'</code></em>) :: <a href="/mrl/combichem.html#SelfiesMutator"><code>SelfiesMutator</code></a></p>
</blockquote>
<p>SelfiesRemove - SELFIES removal mutator.
Randomly removes a SELFIES token in
the input compound</p>
<p>Inputs:</p>
<p><code>n_augs int</code>: number of mutated versions
to generate</p>
<p><code>name str</code>: mutator name</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="MutatorCollection" class="doc_header"><code>class</code> <code>MutatorCollection</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L741" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>MutatorCollection</code>(<strong><code>mutators</code></strong>, <strong><code>p_mutators</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>MutatorCollection - orchestrates a
set of <a href="/mrl/combichem.html#Mutator"><code>Mutator</code></a> classes. When called,
randomly selects a mutator to apply
to the input mol</p>
<p>Inputs:</p>
<p><code>mutators list[Mutator]</code>: list of mutator
objects</p>
<p><code>p_mutators Optional[list[float]]</code>: Optional
list of probabilities for selecting
each mutator. If None, a uniform distribution
is applied</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CombiChem" class="doc_header"><code>class</code> <code>CombiChem</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/combichem.py#L784" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CombiChem</code>(<strong><code>mutator_collection</code></strong>=<em><code>None</code></em>, <strong><code>crossovers</code></strong>=<em><code>None</code></em>, <strong><code>template</code></strong>=<em><code>None</code></em>, <strong><code>rewards</code></strong>=<em><code>None</code></em>, <strong><code>prune_percentile</code></strong>=<em><code>90</code></em>, <strong><code>max_library_size</code></strong>=<em><code>None</code></em>, <strong><code>log</code></strong>=<em><code>False</code></em>, <strong><code>p_explore</code></strong>=<em><code>0.0</code></em>)</p>
</blockquote>
<p>CombiChem - class for running
combichem operations</p>
<p>Inputs:</p>
<p><code>mutator_collection Optional[MutatorCollection]</code>:
Collection of mutations to use</p>
<p><code>crossovers Optional[list[Crossover]]</code>:
list of <a href="/mrl/combichem.html#Crossover"><code>Crossover</code></a> objects</p>
<p><code>template Optional[Template]</code>: <a href="/mrl/template.template.html#Template"><code>Template</code></a> to
control chemical space</p>
<p><code>rewards Optional[Reward]</code>: Rewards to
score molecules</p>
<p><code>prune_percentile int[0,100]</code>: Percentile
of compounds to keep during pruning</p>
<p><code>max_library_size Optional[int]</code>: Maximum
library size after pruning</p>
<p><code>log bool</code>: If True, compounds generated by
combichem are logged</p>
<p><code>p_explore float[0.,1.]</code>: Percentage of
compounds below <code>prune_percentile</code> to keep</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">mrl.templates.all</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">mrl.train.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mrl.torch_imports</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mrl.torch_core</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mrl.layers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mrl.dataloaders</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mrl.model_zoo</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">reward_model</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">outrange</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">15</span><span class="p">])</span>

<span class="n">r_ds</span> <span class="o">=</span> <span class="n">Vec_Prediction_Dataset</span><span class="p">([</span><span class="s1">&#39;C&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">partial</span><span class="p">(</span><span class="n">failsafe_fp</span><span class="p">,</span> <span class="n">fp_function</span><span class="o">=</span><span class="n">ECFP6</span><span class="p">))</span>

<span class="n">r_agent</span> <span class="o">=</span> <span class="n">PredictiveAgent</span><span class="p">(</span><span class="n">reward_model</span><span class="p">,</span> <span class="n">MSELoss</span><span class="p">(),</span> <span class="n">r_ds</span><span class="p">,</span> <span class="n">opt_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span><span class="mf">1e-3</span><span class="p">})</span>

<span class="n">r_agent</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_from_url</span><span class="p">(</span><span class="s1">&#39;egfr_affinity_mlp.pt&#39;</span><span class="p">))</span>

<span class="n">r_agent</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">();</span>

<span class="n">freeze</span><span class="p">(</span><span class="n">r_agent</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

<span class="n">reward</span> <span class="o">=</span> <span class="n">Reward</span><span class="p">(</span><span class="n">r_agent</span><span class="o">.</span><span class="n">predict_data</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

<span class="n">aff_reward</span> <span class="o">=</span> <span class="n">RewardCallback</span><span class="p">(</span><span class="n">reward</span><span class="p">,</span> <span class="s1">&#39;affinity&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">smarts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;[#6](=[#16])(-[#7])-[#7]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;[#6]=[#6]=[#6]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;[#7][F,Cl,Br,I]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;[#6;!R]=[#6;!R]-[#6;!R]=[#6;!R]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;[#6]#[#6]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;[#15]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;[*]=[#17,#9,#35]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;[*]=[*]=[*]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;[*]-[#6]=[#6H2]&#39;</span><span class="p">,</span>
        <span class="s1">&#39;[#7]~[#8]&#39;</span><span class="p">,</span>
         <span class="s1">&#39;[*;R]=[*;!R]&#39;</span><span class="p">]</span>

<span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">([</span><span class="n">ValidityFilter</span><span class="p">(),</span> 
                     <span class="n">SingleCompoundFilter</span><span class="p">(),</span> 
                     <span class="n">RotBondFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                     <span class="n">HeteroatomFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                     <span class="n">ChargeFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                     <span class="n">MaxRingFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                     <span class="n">MinRingFilter</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                     <span class="n">HBDFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                     <span class="n">HBAFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                     <span class="n">MolWtFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
                     <span class="n">LogPFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                     <span class="n">SAFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
                     <span class="n">BridgeheadFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                     <span class="n">PAINSAFilter</span><span class="p">(),</span>
                     <span class="n">ExclusionFilter</span><span class="p">(</span><span class="n">smarts</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">),</span>
                     <span class="n">RotChainFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
                     <span class="n">ChargeFilter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">],</span>
                    <span class="p">[],</span> 
                    <span class="n">fail_score</span><span class="o">=-</span><span class="mf">1.</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_lookup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#     ChangeAtom(),</span>
<span class="c1">#     AppendAtom(),</span>
<span class="c1">#     DeleteAtom(),</span>
<span class="c1">#     ChangeBond(),</span>
<span class="c1">#     InsertAtom(),</span>
<span class="c1">#     AddRing()</span>
<span class="c1"># ]</span>

<span class="n">mutators</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">AllSmarts</span><span class="p">(),</span>
    <span class="n">EnumerateHeterocycleMutator</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">ContractAtom</span><span class="p">(</span><span class="n">include_rings</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">ShuffleNitrogen</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">SelfiesInsert</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">SelfiesReplace</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">SelfiesRemove</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="p">]</span>

<span class="n">mc</span> <span class="o">=</span> <span class="n">MutatorCollection</span><span class="p">(</span><span class="n">mutators</span><span class="p">)</span>

<span class="n">crossovers</span> <span class="o">=</span> <span class="p">[</span><span class="n">FragmentCrossover</span><span class="p">()]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cbc</span> <span class="o">=</span> <span class="n">CombiChem</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">crossovers</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">rewards</span><span class="o">=</span><span class="p">[</span><span class="n">reward</span><span class="p">],</span>
                <span class="n">prune_percentile</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">max_library_size</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p_explore</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">set_global_pool</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">agent</span> <span class="o">=</span> <span class="n">LSTM_LM_Small_Chembl_NC</span><span class="p">(</span><span class="n">drop_scale</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">cbc</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
    <span class="n">new_library</span> <span class="o">=</span> <span class="n">cbc</span><span class="o">.</span><span class="n">build_generation</span><span class="p">()</span>
    <span class="n">new_library</span> <span class="o">=</span> <span class="n">cbc</span><span class="o">.</span><span class="n">clean_library</span><span class="p">(</span><span class="n">new_library</span><span class="p">)</span>
    <span class="n">cbc</span><span class="o">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">new_library</span><span class="p">)</span>
    <span class="n">preds</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">sample_no_grad</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
    <span class="n">smiles</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">reconstruct</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
    <span class="n">cbc</span><span class="o">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="n">cbc</span><span class="o">.</span><span class="n">score_library</span><span class="p">()</span>
    <span class="n">cbc</span><span class="o">.</span><span class="n">prune_library</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">train_from_cbc</span><span class="p">(</span><span class="n">cbc</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">ds_size</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cbc</span><span class="o">.</span><span class="n">library</span><span class="p">,</span> <span class="n">cbc</span><span class="o">.</span><span class="n">old_library</span><span class="p">])</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">ds_size</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">update_dataset_from_inputs</span><span class="p">(</span><span class="n">subset</span><span class="o">.</span><span class="n">smiles</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">agent</span><span class="o">.</span><span class="n">train_supervised</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">5e-5</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">step</span><span class="p">(</span><span class="n">cbc</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
        
    <span class="n">train_from_cbc</span><span class="p">(</span><span class="n">cbc</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="mi">6000</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cbc</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>7.923249970674515
9.045925518274307
9.39971751689911
9.589126468896866
9.681342124938965
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">step</span><span class="p">(</span><span class="n">cbc</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
        
    <span class="n">train_from_cbc</span><span class="p">(</span><span class="n">cbc</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="mi">6000</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cbc</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>9.791439609527588
9.937584570646287
9.953879426717759
10.031412307024002
10.048976805210113
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cbc</span><span class="o">.</span><span class="n">library</span><span class="p">[</span><span class="n">cbc</span><span class="o">.</span><span class="n">library</span><span class="o">.</span><span class="n">score</span><span class="o">&gt;</span><span class="mf">10.6</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>smiles</th>
      <th>mols</th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>NC=C(N)CCc1cc(-c2c(Cc3ccc4cncnc4c3)ncc3ccccc23...</td>
      <td>&lt;rdkit.Chem.rdchem.Mol object at 0x7fc962c80030&gt;</td>
      <td>10.633156</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NC=C(N)Cc1c[nH]c2nc(-c3c(Cc4ccc5cncnc5c4)ncc4c...</td>
      <td>&lt;rdkit.Chem.rdchem.Mol object at 0x7fc962feb9b0&gt;</td>
      <td>10.631518</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NC=C(N)CCc1c[nH]c2nc(-c3c(Cc4ccc5cncnc5c4)ncc4...</td>
      <td>&lt;rdkit.Chem.rdchem.Mol object at 0x7fc9644a2eb0&gt;</td>
      <td>10.611439</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NC=C(N)CCc1cc(-c2c(Cc3ccc4cncnc4c3)ncc3ccccc23...</td>
      <td>&lt;rdkit.Chem.rdchem.Mol object at 0x7fc962d8ae30&gt;</td>
      <td>10.609367</td>
    </tr>
    <tr>
      <th>4</th>
      <td>N=CCc1cc(-c2c(Cc3ccc4cncnc4c3)ncc3ccccc23)c(CC...</td>
      <td>&lt;rdkit.Chem.rdchem.Mol object at 0x7fc9623e2970&gt;</td>
      <td>10.601992</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

