---

title: Environment


keywords: fastai
sidebar: home_sidebar

summary: "Environment/Callback"
description: "Environment/Callback"
nb_path: "nbs/12_environment.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/12_environment.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>//anaconda3/envs/mrl/lib/python3.6/importlib/_bootstrap.py:219: RuntimeWarning: to-Python converter for boost::shared_ptr&lt;RDKit::FilterCatalogEntry const&gt; already registered; second conversion method ignored.
  return f(*args, **kwds)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Callback" class="doc_header"><code>class</code> <code>Callback</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L17" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Callback</code>(<strong><code>name</code></strong>=<em><code>'callback'</code></em>, <strong><code>order</code></strong>=<em><code>10</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BatchStats" class="doc_header"><code>class</code> <code>BatchStats</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L32" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BatchStats</code>() :: <a href="/mrl/environment.html#Callback"><code>Callback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Buffer" class="doc_header"><code>class</code> <code>Buffer</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L83" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Buffer</code>(<strong><code>p_total</code></strong>, <strong><code>max_size</code></strong>=<em><code>1000000</code></em>) :: <a href="/mrl/environment.html#Callback"><code>Callback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SettrDict" class="doc_header"><code>class</code> <code>SettrDict</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L133" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SettrDict</code>() :: <code>dict</code></p>
</blockquote>
<p>dict() -&gt; new empty dictionary
dict(mapping) -&gt; new dictionary initialized from a mapping object's
    (key, value) pairs
dict(iterable) -&gt; new dictionary initialized as if via:
    d = {}
    for k, v in iterable:
        d[k] = v
dict(**kwargs) -&gt; new dictionary initialized with the name=value pairs
    in the keyword argument list.  For example:  dict(one=1, two=2)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BatchState" class="doc_header"><code>class</code> <code>BatchState</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L149" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BatchState</code>() :: <a href="/mrl/environment.html#SettrDict"><code>SettrDict</code></a></p>
</blockquote>
<p>dict() -&gt; new empty dictionary
dict(mapping) -&gt; new dictionary initialized from a mapping object's
    (key, value) pairs
dict(iterable) -&gt; new dictionary initialized as if via:
    d = {}
    for k, v in iterable:
        d[k] = v
dict(**kwargs) -&gt; new dictionary initialized with the name=value pairs
    in the keyword argument list.  For example:  dict(one=1, two=2)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Event" class="doc_header"><code>class</code> <code>Event</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L182" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Event</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Environment" class="doc_header"><code>class</code> <code>Environment</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L203" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Environment</code>(<strong><code>agent_cb</code></strong>, <strong><code>template</code></strong>=<em><code>None</code></em>, <strong><code>samplers</code></strong>=<em><code>[]</code></em>, <strong><code>reward_cbs</code></strong>=<em><code>[]</code></em>, <strong><code>loss_cbs</code></strong>=<em><code>[]</code></em>, <strong><code>cbs</code></strong>=<em><code>[]</code></em>, <strong><code>buffer_p_batch</code></strong>=<em><code>None</code></em>, <strong><code>reward_decay</code></strong>=<em><code>0.9</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Sampler" class="doc_header"><code>class</code> <code>Sampler</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L306" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Sampler</code>(<strong><code>name</code></strong>, <strong><code>p_buffer</code></strong>=<em><code>0.0</code></em>, <strong><code>p_batch</code></strong>=<em><code>0.0</code></em>, <strong><code>track</code></strong>=<em><code>True</code></em>) :: <a href="/mrl/environment.html#Callback"><code>Callback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ModelSampler" class="doc_header"><code>class</code> <code>ModelSampler</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L354" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ModelSampler</code>(<strong><code>agent</code></strong>, <strong><code>model</code></strong>, <strong><code>name</code></strong>, <strong><code>p_buffer</code></strong>, <strong><code>p_batch</code></strong>, <strong><code>genbatch</code></strong>, <strong><code>latent</code></strong>=<em><code>False</code></em>, <strong><code>track</code></strong>=<em><code>True</code></em>) :: <a href="/mrl/environment.html#Sampler"><code>Sampler</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TemplateCallback" class="doc_header"><code>class</code> <code>TemplateCallback</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L437" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TemplateCallback</code>(<strong><code>template</code></strong>=<em><code>None</code></em>) :: <a href="/mrl/environment.html#Callback"><code>Callback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="AgentCallback" class="doc_header"><code>class</code> <code>AgentCallback</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L480" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>AgentCallback</code>(<strong><code>agent</code></strong>, <strong><code>name</code></strong>) :: <a href="/mrl/environment.html#Callback"><code>Callback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="GenAgentCallback" class="doc_header"><code>class</code> <code>GenAgentCallback</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L503" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>GenAgentCallback</code>(<strong><code>agent</code></strong>, <strong><code>name</code></strong>, <strong><code>contrastive</code></strong>=<em><code>False</code></em>) :: <a href="/mrl/environment.html#AgentCallback"><code>AgentCallback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RewardCallback" class="doc_header"><code>class</code> <code>RewardCallback</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L602" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RewardCallback</code>(<strong><code>reward_function</code></strong>, <strong><code>name</code></strong>, <strong><code>weight</code></strong>=<em><code>1.0</code></em>) :: <a href="/mrl/environment.html#Callback"><code>Callback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="LossCallback" class="doc_header"><code>class</code> <code>LossCallback</code><a href="https://github.com/DarkMatterAI/mrl/tree/main/mrl/environment.py#L621" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>LossCallback</code>(<strong><code>loss_function</code></strong>, <strong><code>name</code></strong>, <strong><code>weight</code></strong>=<em><code>1.0</code></em>) :: <a href="/mrl/environment.html#Callback"><code>Callback</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">mrl.dataloaders</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mrl.layers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mrl.g_models</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">mrl.policy_gradient</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">vocab</span> <span class="o">=</span> <span class="n">CharacterVocab</span><span class="p">(</span><span class="n">SMILES_CHAR_VOCAB</span><span class="p">)</span>

<span class="c1"># ds = TextDataset([&#39;CCC&#39;], vocab)</span>

<span class="c1"># d_vocab = len(vocab.itos)</span>
<span class="c1"># d_embedding = 256</span>
<span class="c1"># d_hidden = 1024</span>
<span class="c1"># n_layers = 3</span>
<span class="c1"># lstm_drop = 0.</span>
<span class="c1"># lin_drop = 0.</span>
<span class="c1"># bos_idx = vocab.stoi[&#39;bos&#39;]</span>
<span class="c1"># bidir = False</span>
<span class="c1"># tie_weights = True</span>

<span class="c1"># lm_model = LSTM_LM(d_vocab, d_embedding, d_hidden, n_layers,</span>
<span class="c1">#                 lstm_drop, lin_drop, bos_idx, bidir, tie_weights)</span>

<span class="c1"># lm_model.load_state_dict(torch.load(&#39;untracked_files/lstm_lm_small.pt&#39;))</span>

<span class="k">def</span> <span class="nf">vector_reconstruction_collate2</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pad_idx</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">vector_reconstruction_collate</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pad_idx</span><span class="p">,</span> <span class="n">batch_first</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">to_device</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<span class="n">collate</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">vector_reconstruction_collate2</span><span class="p">,</span> <span class="n">pad_idx</span><span class="o">=</span><span class="n">vocab</span><span class="o">.</span><span class="n">stoi</span><span class="p">[</span><span class="s1">&#39;pad&#39;</span><span class="p">])</span>
<span class="c1"># ds = Vec_Recon_Dataset([&#39;CCC&#39;], vocab, ECFP6, collate_function=collate)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">Vec_Recon_Dataset</span><span class="p">([</span><span class="s1">&#39;CCC&#39;</span><span class="p">],</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">failsafe_fp</span><span class="p">,</span> <span class="n">fp_function</span><span class="o">=</span><span class="n">ECFP6</span><span class="p">),</span> <span class="n">collate_function</span><span class="o">=</span><span class="n">collate</span><span class="p">)</span>

<span class="n">d_vocab</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab</span><span class="o">.</span><span class="n">itos</span><span class="p">)</span>
<span class="n">d_embedding</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">encoder_d_in</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">encoder_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">]</span>
<span class="n">encoder_drops</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
<span class="n">d_hidden</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">n_layers</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">d_latent</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">dec_drop</span><span class="o">=</span><span class="mf">0.0</span>
<span class="n">condition_hidden</span><span class="o">=</span><span class="kc">True</span>
<span class="n">condition_output</span><span class="o">=</span><span class="kc">True</span>
<span class="n">prior</span><span class="o">=</span><span class="kc">None</span>
<span class="n">bos_idx</span><span class="o">=</span><span class="mi">0</span>

<span class="n">lm_model</span> <span class="o">=</span> <span class="n">MLP_VAE</span><span class="p">(</span><span class="n">d_vocab</span><span class="p">,</span> <span class="n">d_embedding</span><span class="p">,</span> <span class="n">encoder_d_in</span><span class="p">,</span> <span class="n">encoder_dims</span><span class="p">,</span> <span class="n">encoder_drops</span><span class="p">,</span>
                <span class="n">d_hidden</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">d_latent</span><span class="p">,</span> <span class="n">dec_drop</span><span class="p">,</span> <span class="n">condition_hidden</span><span class="p">,</span> <span class="n">condition_output</span><span class="p">,</span>
                <span class="n">prior</span><span class="p">,</span> <span class="n">bos_idx</span><span class="p">)</span>

<span class="n">lm_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;untracked_files/fp_vae.pt&#39;</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;All keys matched successfully&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">latents</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="mi">512</span><span class="p">,</span> <span class="n">lm_model</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">d_latent</span><span class="p">))</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">GenerativeAgent</span><span class="p">(</span><span class="n">lm_model</span><span class="p">,</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">CrossEntropy</span><span class="p">(),</span> <span class="n">ds</span><span class="p">,</span> <span class="n">value_head</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opt_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span><span class="mf">1e-4</span><span class="p">},</span>
                       <span class="n">latents</span><span class="o">=</span><span class="n">latents</span><span class="p">,</span> <span class="n">lopt_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span><span class="mf">5e-2</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">scale_sa</span><span class="p">(</span><span class="n">sa</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">10</span><span class="o">-</span><span class="n">sa</span><span class="p">)</span><span class="o">/</span><span class="mi">9</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">([</span><span class="n">ValidityFilter</span><span class="p">(),</span> <span class="n">SingleCompoundFilter</span><span class="p">()],</span>
                    <span class="p">[</span><span class="n">QEDFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">PassThroughScore</span><span class="p">()),</span>
                     <span class="n">SAFilter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> 
                              <span class="n">score</span><span class="o">=</span><span class="n">PropertyFunctionScore</span><span class="p">(</span><span class="n">scale_sa</span><span class="p">))],</span> <span class="n">fail_score</span><span class="o">=-</span><span class="mf">1.</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">agent_cb</span> <span class="o">=</span> <span class="n">GenAgentCallback</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;generative&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sampler1</span> <span class="o">=</span> <span class="n">ModelSampler</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;live&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">latent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">track</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sampler2</span> <span class="o">=</span> <span class="n">ModelSampler</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pg</span> <span class="o">=</span> <span class="n">TRPO</span><span class="p">(</span><span class="mf">0.97</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># pg = PPO(0.97, 0.2)</span>

<span class="n">loss1</span> <span class="o">=</span> <span class="n">LossCallback</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="s1">&#39;pg&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">agent_cb</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">samplers</span><span class="o">=</span><span class="p">[</span><span class="n">sampler1</span><span class="p">,</span> <span class="n">sampler2</span><span class="p">],</span> <span class="n">loss_cbs</span><span class="o">=</span><span class="p">[</span><span class="n">loss1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>iterations  diversity  valid     rewards   mean_reward  pg      
0           1.0000     1.0000    1.4666    1.4666       -0.0594   
2           1.0000     1.0000    1.5139    1.4767       -0.1753   
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">latents</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Parameter containing:
tensor([[-0.1935,  1.4924, -0.9727,  ...,  0.7760,  1.0539, -0.0467],
        [-2.2043, -1.5967,  0.4668,  ...,  1.4769,  0.3255, -1.7293],
        [-0.3555,  1.0331, -0.7472,  ..., -2.1751, -0.4008, -0.0151],
        ...,
        [ 0.3621, -0.2385,  0.8898,  ..., -1.2590, -1.2098, -2.1632],
        [-0.2352,  0.1179,  1.0164,  ...,  1.3276,  0.1995, -1.2525],
        [ 0.9578, -0.1522, -0.9425,  ...,  0.5103, -0.1675,  0.9462]],
       requires_grad=True)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>iterations  diversity  valid     rewards   mean_reward  live_diversity  live_valid  live_rewards  pg      
4           1.00       1.00      1.51      1.47         1.00            1.00        1.53          -0.16     
6           1.00       1.00      1.53      1.48         1.00            0.94        1.57          -0.22     
8           1.00       1.00      1.53      1.49         1.00            1.00        1.52          -0.21     
10          1.00       1.00      1.50      1.50         1.00            1.00        1.50          -0.10     
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">latents</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Parameter containing:
tensor([[-0.1935,  1.4924, -0.9727,  ...,  0.7760,  1.0539, -0.0467],
        [-2.2043, -1.5967,  0.4668,  ...,  1.4769,  0.3255, -1.7293],
        [-0.2593,  0.9368, -0.8431,  ..., -2.2716, -0.4973, -0.1111],
        ...,
        [ 0.3621, -0.2385,  0.8898,  ..., -1.2590, -1.2098, -2.1632],
        [-0.1352,  0.0240,  1.1168,  ...,  1.2277,  0.2997, -1.3509],
        [ 0.9578, -0.1522, -0.9425,  ...,  0.5103, -0.1675,  0.9462]],
       requires_grad=True)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">env</span><span class="o">.</span><span class="n">sl</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">env</span><span class="o">.</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">50</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="p">(</span><span class="s1">&#39;before_train&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>iterations	diversity	valid	rewards	live_diversity	live_valid	live_rewards	pg
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">build_buffer</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">sample_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="p">(</span><span class="s1">&#39;get_model_outputs&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">compute_reward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>running
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">batch_stats</span><span class="o">.</span><span class="n">live_rewards</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[1.3644245]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">compute_loss</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="p">(</span><span class="s1">&#39;after_batch&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>0.00	1.00	0.97	1.41	1.00	0.94	1.36	-0.10
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="p">(</span><span class="s1">&#39;after_train&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>iterations  diversity  valid     rewards   live_diversity  live_valid  live_rewards  pg      
0           1.00       1.00      1.53      1.00            1.00        1.55          0.01      
1           1.00       1.00      1.50      1.00            1.00        1.52          0.04      
2           1.00       1.00      1.51      1.00            1.00        1.55          0.01      
3           1.00       1.00      1.51      1.00            1.00        1.55          0.04      
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">batch_stats</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;fastprogress.fastprogress.ConsoleMasterBar at 0x1377145f8&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">batch_stats</span><span class="p">(</span><span class="s1">&#39;after_batch&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>5         1.00      1.00      1.49      1.00      1.00      1.47      0.04      
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

